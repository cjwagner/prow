var __awaiter=window&&window.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(i,a){function r(t){try{l(o.next(t))}catch(t){a(t)}}function s(t){try{l(o.throw(t))}catch(t){a(t)}}function l(t){t.done?i(t.value):function e(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(r,s)}l((o=o.apply(t,e||[])).next())}))};function showElem(t){t.className="shown",t.innerHTML=ansiToHTML(t.innerHTML)}function ansiToHTML(t){function e(t,e){const n=+t.replace("0;","");return 0===n?e:1===n?`<strong>${e}</strong>`:3===n?`<em>${e}</em>`:30<=n&&n<=37?`<span class="ansi-${n-30}">${e}</span>`:90<=n&&n<=97?`<span class="ansi-${n-90+8}">${e}</span>`:e}const n=t.replace(/\033\[([0-9;]*)\w(\033\[1m)?([^\033]*?)\033\[0m/g,(t,n,o,i,a,r)=>void 0!==o?`<strong>${e(n,i)}</strong>`:e(n,i));return n.replace(/\033\[([0-9;]*\w)/g,(t,e,o,i)=>(console.log("unhandled ansi code: ",e,"context:",n),""))}function replaceElementWithContent(t){return __awaiter(this,void 0,void 0,(function*(){const{artifact:e,offset:n,length:o,startLine:i}=t.dataset,a=yield spyglass.request(JSON.stringify({artifact:e,length:+o,offset:+n,startLine:+i}));if(t.innerHTML=ansiToHTML(a),fixLinks(t),showElem(t),0===document.getElementById(`${e}-content`).querySelectorAll(".show-skipped").length){const t=document.querySelector("button.show-all-button");t.parentNode.removeChild(t)}spyglass.contentUpdated()}))}function handleShowSkipped(t){return __awaiter(this,void 0,void 0,(function*(){t.target instanceof HTMLButtonElement&&(yield replaceElementWithContent(this))}))}function handleShowAll(){return __awaiter(this,void 0,void 0,(function*(){this.parentElement&&this.parentElement.removeChild(this);const{artifact:t}=this.dataset,e=yield spyglass.request(JSON.stringify({artifact:t,offset:0,length:-1}));document.getElementById(`${t}-content`).innerHTML=`<tbody class="shown">${ansiToHTML(e)}</tbody>`,spyglass.contentUpdated()}))}function handleLineLink(t){if(!t.target)return;const e=t.target;e.dataset.lineNumber&&(location.hash=`#${e.dataset.artifact}:${e.dataset.lineNumber}`,t.preventDefault())}function highlightLine(t){for(const t of Array.from(document.querySelectorAll(".highlighted-line")))t.classList.remove("highlighted-line");t.classList.add("highlighted-line")}function fixLinks(t){const e=t.querySelectorAll("a[data-artifact][data-line-number]");for(const t of Array.from(e))t.href=spyglass.makeFragmentLink(`${t.dataset.artifact}:${t.dataset.lineNumber}`)}function loadLine(t,e){return __awaiter(this,void 0,void 0,(function*(){const n=document.querySelectorAll(`.show-skipped[data-artifact="${t}"]`);for(const t of Array.from(n))if(e>=Number(t.dataset.startLine)&&e<Number(t.dataset.endLine))return yield replaceElementWithContent(t),!0;return!1}))}function handleHash(){return __awaiter(this,void 0,void 0,(function*(){const t=location.hash.substr(1),e=t.lastIndexOf(":");if(-1===e)return;const n=t.substring(0,e),o=Number(t.substring(e+1));if(isNaN(o))return;const i=`${n}:${o}`;let a=document.getElementById(i);if(!a){if(!(yield loadLine(n,o)))return;if(!(a=document.getElementById(i)))return}const r=a.getBoundingClientRect().top+window.pageYOffset;highlightLine(a),spyglass.scrollTo(0,r).then()}))}window.addEventListener("hashchange",()=>handleHash()),window.addEventListener("load",()=>{const t=document.getElementsByClassName("shown");for(const e of Array.from(t))e.innerHTML=ansiToHTML(e.innerHTML);for(const t of Array.from(document.querySelectorAll(".show-skipped")))t.addEventListener("click",handleShowSkipped);for(const t of Array.from(document.querySelectorAll("button.show-all-button")))t.addEventListener("click",handleShowAll);for(const t of Array.from(document.querySelectorAll(".loglines")))t.addEventListener("click",handleLineLink,{capture:!0});fixLinks(document.documentElement),handleHash()});